<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุณุงุช ูููุณ | ููุตุฉ ุงูุฎุฏูุงุช ุงููุชูุงููุฉ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f3f4f6; }
        .active-tab { background-color: #1e3a8a; color: white; }
        .hidden-section { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* ูุชุณููู ุฅุฎูุงุก ููุฏุงู ุงูุชูููู */
        .rating-star:hover { color: gold; cursor: pointer; }
    </style>
</head>
<body class="pb-20">

    <div id="login-screen" class="fixed inset-0 bg-blue-900 z-50 flex flex-col items-center justify-center text-white p-6">
        <h1 class="text-4xl font-black mb-2">๐ก ุณุงุช ูููุณ</h1>
        <p class="mb-8 opacity-80">ุงุฎุชุฑ ููุน ุงูุญุณุงุจ ููุฏุฎูู</p>
        
        <div class="space-y-4 w-full max-w-sm">
            <button onclick="loginAs('client')" class="w-full bg-white text-blue-900 py-3 rounded-xl font-bold hover:bg-gray-100 flex items-center justify-center gap-2">
                <i class="fas fa-user"></i> ุฏุฎูู ูู ุฒุจูู
            </button>
            <button onclick="loginAs('tech')" class="w-full bg-blue-700 border border-blue-500 py-3 rounded-xl font-bold hover:bg-blue-600 flex items-center justify-center gap-2">
                <i class="fas fa-tools"></i> ุฏุฎูู ูู ููู
            </button>
            <button onclick="loginAs('admin')" class="w-full bg-gray-800 border border-gray-600 py-3 rounded-xl font-bold hover:bg-gray-700 flex items-center justify-center gap-2">
                <i class="fas fa-lock"></i> ุฏุฎูู ูู ุฅุฏุงุฑุฉ (Admin)
            </button>
        </div>
        <p class="mt-8 text-xs text-blue-300">ูุถุน ุชุฌุฑูุจู: ุงูุจูุงูุงุช ุชุญูุธ ูู ุฌูุงุฒู ููุท</p>
    </div>

    <nav class="bg-blue-900 text-white p-4 shadow-lg sticky top-0 z-40">
        <div class="flex justify-between items-center max-w-2xl mx-auto">
            <h1 class="text-xl font-bold flex items-center gap-2">๐ก ุณุงุช ูููุณ</h1>
            <div class="flex items-center gap-3">
                <span id="user-role-badge" class="text-xs bg-blue-700 px-3 py-1 rounded-full border border-blue-500">ุฒุงุฆุฑ</span>
                <button onclick="logout()" class="text-xs bg-red-500 px-2 py-1 rounded hover:bg-red-600"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </nav>

    <div class="max-w-2xl mx-auto p-4">

        <div id="client-panel" class="hidden-section fade-in">
            <div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-2xl p-6 text-white mb-6 text-center">
                <h2 class="text-2xl font-bold mb-2">ูู ุชูุงุฌู ูุดููุฉ ูู ุงูุชููุงุฒุ</h2>
                <p class="text-sm opacity-90 mb-4">ุงุทูุจ ููู ูุญุชุฑู ุงูุขู ููุตูู ูุจุงุจ ุงูููุฒู</p>
                <button onclick="showServiceForm()" class="bg-white text-purple-700 px-6 py-2 rounded-full font-bold shadow hover:scale-105 transition">ุทูุจ ุฎุฏูุฉ ุตูุงูุฉ</button>
            </div>
            
            <h3 class="font-bold text-gray-800 text-lg mb-4 border-b pb-2">โญ ุชููููุงุช ููุฏ ุงูุงูุชุธุงุฑ</h3>
            <div id="pending-reviews-list" class="space-y-3 mb-6">
                <div class="text-center text-gray-400 py-2">ูุง ุชูุฌุฏ ุฎุฏูุงุช ุจุงูุชุธุงุฑ ุงูุชูููู.</div>
            </div>

            <h3 class="font-bold text-gray-800 text-lg mb-4 border-b pb-2">๐ ุชุณูู ุฃุญุฏุซ ุงูุฃุฌูุฒุฉ</h3>
            <div id="client-products-list" class="grid grid-cols-2 gap-4">
                </div>
        </div>

        <div id="service-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center justify-center p-4">
            <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl animate-bounce-up">
                <h3 class="font-bold text-xl mb-4">๐๏ธ ุทูุจ ููู ุตูุงูุฉ</h3>
                <input type="text" id="req-name" placeholder="ุงุณูู ุงููุงูู" class="w-full p-3 bg-gray-50 rounded-lg mb-3 border">
                <select id="req-type" class="w-full p-3 bg-gray-50 rounded-lg mb-3 border">
                    <option value="ุถุจุท ุฅุดุงุฑุฉ">ุถุจุท ุฅุดุงุฑุฉ (Parabole)</option>
                    <option value="ุชุฑููุจ ุชููุงุฒ">ุชุฑููุจ ุชููุงุฒ ุฌุฏูุฏ</option>
                    <option value="ุงุดุชุฑุงู IPTV">ุชุฌุฏูุฏ ุงุดุชุฑุงู IPTV</option>
                    <option value="ุตูุงูุฉ ุนุงูุฉ">ุตูุงูุฉ ุนุงูุฉ</option>
                </select>
                <input type="text" id="req-address" placeholder="ุงููุฏููุฉ ูุงูุนููุงู" class="w-full p-3 bg-gray-50 rounded-lg mb-3 border">
                <button onclick="submitServiceRequest()" class="w-full bg-blue-900 text-white py-3 rounded-lg font-bold">ุฅุฑุณุงู ุงูุทูุจ</button>
                <button onclick="document.getElementById('service-modal').classList.add('hidden')" class="w-full mt-2 text-gray-500 py-2">ุฅูุบุงุก</button>
            </div>
        </div>

        <div id="rating-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center justify-center p-4">
            <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl animate-bounce-up text-center">
                <h3 class="font-bold text-xl mb-4">๐ ุชูููู ุงูุฎุฏูุฉ</h3>
                <p id="rating-modal-info" class="text-sm text-gray-600 mb-4">ุชูููู ุงูููู [ุงุณู ุงูููู] ุจุนุฏ ุฎุฏูุฉ [ููุน ุงูุฎุฏูุฉ].</p>
                <div id="star-rating-area" class="text-4xl text-gray-300 mb-6">
                    <i class="fas fa-star rating-star" data-rating="1" onclick="selectRating(1)"></i>
                    <i class="fas fa-star rating-star" data-rating="2" onclick="selectRating(2)"></i>
                    <i class="fas fa-star rating-star" data-rating="3" onclick="selectRating(3)"></i>
                    <i class="fas fa-star rating-star" data-rating="4" onclick="selectRating(4)"></i>
                    <i class="fas fa-star rating-star" data-rating="5" onclick="selectRating(5)"></i>
                </div>
                <input type="hidden" id="current-req-id">
                <input type="hidden" id="selected-rating">
                <button onclick="submitRating()" class="w-full bg-yellow-500 text-white py-3 rounded-lg font-bold hover:bg-yellow-600">ุฅุฑุณุงู ุงูุชูููู</button>
                <button onclick="document.getElementById('rating-modal').classList.add('hidden')" class="w-full mt-2 text-gray-500 py-2">ุชุฎุทู ุญุงููุงู</button>
            </div>
        </div>


        <div id="tech-panel" class="hidden-section fade-in">
            <div class="bg-gray-800 text-white p-6 rounded-2xl shadow-xl mb-6 relative overflow-hidden">
                <div class="absolute top-0 left-0 p-4 opacity-10 text-6xl"><i class="fas fa-wallet"></i></div>
                <p class="text-gray-400 text-xs font-bold">ุฑุตูุฏ ุงูุนูููุงุช ุงูููุชุณุจุฉ</p>
                <div class="flex items-end gap-2 mt-1">
                    <h2 id="tech-wallet" class="text-4xl font-black text-green-400">0</h2>
                    <span class="text-sm mb-1">ุฏุฑูู</span>
                </div>
                <button onclick="requestPayout()" class="absolute bottom-3 left-3 bg-green-600 text-white text-xs px-3 py-1 rounded-full hover:bg-green-700 transition"><i class="fas fa-hand-holding-usd ml-1"></i> ุณุญุจ ุงูุฃุฑุจุงุญ</button>
            </div>

            <div class="flex mb-4 bg-white p-1 rounded-xl shadow-sm">
                <button onclick="switchTechTab('products')" class="flex-1 py-2 rounded-lg text-sm font-bold active-tab" id="tab-btn-products">ุดุฑุงุก ููุชุฌุงุช</button>
                <button onclick="switchTechTab('requests')" class="flex-1 py-2 rounded-lg text-sm font-bold text-gray-500" id="tab-btn-requests">ุทูุจุงุช ุงูุนูู ๐</button>
            </div>

            <div id="tech-products-view">
                <div id="tech-products-list" class="space-y-4"></div>
            </div>

            <div id="tech-requests-view" class="hidden-section space-y-3">
                <div id="requests-list"></div>
            </div>
        </div>

        <div id="admin-panel" class="hidden-section fade-in">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-blue-100 p-4 rounded-xl text-blue-800 text-center">
                    <h3 class="font-bold text-2xl" id="total-users">0</h3>
                    <p class="text-xs">ูุณุชุฎุฏู</p>
                </div>
                <div class="bg-green-100 p-4 rounded-xl text-green-800 text-center">
                    <h3 class="font-bold text-2xl" id="total-sales">0</h3>
                    <p class="text-xs">ูุจูุนุงุช</p>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                <h3 class="font-bold text-lg mb-4 text-gray-800">โ ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ ูููููุน</h3>
                <input type="text" id="prod-name" placeholder="ุงุณู ุงูููุชุฌ" class="w-full mb-2 p-2 border rounded">
                <div class="flex gap-2 mb-2">
                    <input type="number" id="prod-price" placeholder="ุงูุณุนุฑ ููุนููู" class="w-full p-2 border rounded">
                    <input type="number" id="prod-comm" placeholder="ุนูููุฉ ุงูููู" class="w-full p-2 border rounded">
                </div>
                <input type="text" id="prod-img" placeholder="ุฑุงุจุท ุงูุตูุฑุฉ (ุงุฎุชูุงุฑู)" class="w-full mb-3 p-2 border rounded">
                <button onclick="adminAddProduct()" class="w-full bg-black text-white py-2 rounded font-bold">ูุดุฑ ุงูููุชุฌ</button>
            </div>

            <h3 class="font-bold mt-6 mb-3">๐ฆ ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช ุงูุญุงููุฉ</h3>
            <div id="admin-products-list" class="space-y-2"></div>
            
            <h3 class="font-bold mt-6 mb-3">๐๏ธ ูุฑุงุฌุนุฉ ุงูุทูุจุงุช ุงูููุชููุฉ</h3>
            <div id="admin-completed-requests" class="space-y-2">
                <div class="text-center text-gray-400 py-2">ูุง ุชูุฌุฏ ุทูุจุงุช ููุชููุฉ ูููุฑุงุฌุนุฉ.</div>
            </div>
        </div>

    </div>

    <script>
        // === 1. ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุญุงููุฉ (LocalStorage) ===
        const defaultProducts = [
            { id: 1, name: "ุฑุณููุฑ Echolink HD", price: 250, comm: 50, img: "https://m.media-amazon.com/images/I/61H+1n+2O2L.jpg" },
            { id: 2, name: "ูุงูุท LNB 4 ูุฎุงุฑุฌ", price: 80, comm: 20, img: "https://m.media-amazon.com/images/I/51pQv+k-GHL.jpg" },
            { id: 3, name: "TV Box Android 4K", price: 400, comm: 80, img: "https://m.media-amazon.com/images/I/61STzN5rO+L.jpg" }
        ];

        let db = {
            products: JSON.parse(localStorage.getItem('satfix_products')) || defaultProducts,
            requests: JSON.parse(localStorage.getItem('satfix_requests')) || [],
            techWallet: parseInt(localStorage.getItem('satfix_wallet')) || 0,
            salesCount: parseInt(localStorage.getItem('satfix_sales')) || 0
        };

        let currentUserRole = null;
        
        // === 2. ูุธุงุฆู ุงููุธุงู ุงูุฃุณุงุณูุฉ ===

        function saveData() {
            localStorage.setItem('satfix_products', JSON.stringify(db.products));
            localStorage.setItem('satfix_requests', JSON.stringify(db.requests));
            localStorage.setItem('satfix_wallet', db.techWallet);
            localStorage.setItem('satfix_sales', db.salesCount);
        }

        function loginAs(role) {
            currentUserRole = role;
            sessionStorage.setItem('current_user_role', role);

            document.getElementById('login-screen').classList.add('hidden');
            
            // ุฅุฎูุงุก ุฌููุน ุงูุฃูุณุงู
            document.getElementById('client-panel').classList.add('hidden-section');
            document.getElementById('tech-panel').classList.add('hidden-section');
            document.getElementById('admin-panel').classList.add('hidden-section');

            // ุฅุธูุงุฑ ุงููุณู ุงูููุงุณุจ ูุชุญุฏูุซ ุงูุจูุงูุงุช
            if (role === 'client') {
                document.getElementById('client-panel').classList.remove('hidden-section');
                document.getElementById('user-role-badge').innerText = "ุฒุจูู";
                renderClientProducts();
                renderPendingReviews(); // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุชููููุงุช ุงููุนููุฉ
            } else if (role === 'tech') {
                document.getElementById('tech-panel').classList.remove('hidden-section');
                document.getElementById('user-role-badge').innerText = "ููู";
                updateTechWallet();
                renderTechProducts();
                switchTechTab('products'); // ุนุฑุถ ุงูููุชุฌุงุช ุงูุชุฑุงุถูุงู
            } else if (role === 'admin') {
                document.getElementById('admin-panel').classList.remove('hidden-section');
                document.getElementById('user-role-badge').innerText = "ูุฏูุฑ";
                renderAdminStats();
                renderAdminProducts();
                renderAdminCompletedRequests(); // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุทูุจุงุช ุงูููุชููุฉ
            }
        }

        function logout() {
            sessionStorage.removeItem('current_user_role');
            location.reload();
        }

        // === 3. ูุธุงุฆู ุงูุฒุจูู ===
        function renderClientProducts() {
            const container = document.getElementById('client-products-list');
            container.innerHTML = db.products.map(p => `
                <div class="bg-white p-3 rounded-xl shadow-sm">
                    <img src="${p.img}" class="w-full h-32 object-contain mb-2">
                    <h4 class="font-bold text-sm h-10 overflow-hidden">${p.name}</h4>
                    <div class="flex justify-between items-center mt-2">
                        <span class="font-bold text-blue-900">${p.price} ุฏุฑูู</span>
                        <button onclick="clientBuy(${p.id})" class="bg-blue-900 text-white px-3 py-1 rounded text-xs">ุดุฑุงุก</button>
                    </div>
                </div>
            `).join('');
        }

        function clientBuy(id) {
            alert("โ ุชู ุงุณุชูุงู ุทูุจู! ุณูุชุตู ุจู ููุชูุตูู.");
            db.salesCount++;
            saveData();
        }

        function showServiceForm() {
            document.getElementById('service-modal').classList.remove('hidden');
        }

        function submitServiceRequest() {
            const name = document.getElementById('req-name').value;
            const type = document.getElementById('req-type').value;
            const address = document.getElementById('req-address').value;

            if(!name || !address) return alert("ุงููุฑุฌู ููุก ุงููุนูููุงุช");

            db.requests.push({
                id: Date.now(),
                name, 
                type, 
                address, 
                status: 'pending',
                technician_name: null, // ุณูุชู ุชุญุฏูุซู ุนูุฏ ุงููุจูู
                rating: null,
                date: new Date().toLocaleDateString('ar-EG')
            });
            saveData();
            
            document.getElementById('service-modal').classList.add('hidden');
            alert("๐ ุชู ุฅุฑุณุงู ุงูุทูุจ ููููููู ูู ููุทูุชู!");
        }

        // === 3-1. ูุธุงุฆู ุงูุชูููู (ุงูุฒุจูู) ===

        function renderPendingReviews() {
            const container = document.getElementById('pending-reviews-list');
            // ุงุจุญุซ ุนู ุงูุทูุจุงุช ุงูููุชููุฉ ุงูุชู ูู ูุชู ุชูููููุง ุจุนุฏ
            const reviewableRequests = db.requests.filter(r => r.status === 'completed' && r.rating === null);

            if(reviewableRequests.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-2">ูุง ุชูุฌุฏ ุฎุฏูุงุช ุจุงูุชุธุงุฑ ุงูุชูููู.</div>';
                return;
            }

            container.innerHTML = reviewableRequests.map(r => `
                <div class="bg-yellow-50 border-r-4 border-yellow-400 p-4 rounded shadow-sm flex justify-between items-center">
                    <div>
                        <h4 class="font-bold text-gray-800">${r.type}</h4>
                        <p class="text-xs text-gray-600">ุงูููู: ${r.technician_name || 'ุบูุฑ ูุนุฑูู'}</p>
                    </div>
                    <button onclick="showRatingModal(${r.id}, '${r.type}', '${r.technician_name}')" class="bg-yellow-500 text-white px-3 py-1 rounded text-sm hover:bg-yellow-600">ุชูููู ุงูุขู</button>
                </div>
            `).join('');
        }

        function showRatingModal(reqId, type, techName) {
            document.getElementById('current-req-id').value = reqId;
            document.getElementById('rating-modal-info').innerText = `ุชูููู ุงูููู ${techName} ุจุนุฏ ุฎุฏูุฉ ${type}.`;
            // ุชุตููุฑ ุงููุฌูู
            document.querySelectorAll('.rating-star').forEach(star => star.style.color = 'rgb(209 213 219)'); // ููู ุฑูุงุฏู
            document.getElementById('selected-rating').value = '';
            document.getElementById('rating-modal').classList.remove('hidden');
        }

        function selectRating(rating) {
            document.getElementById('selected-rating').value = rating;
            document.querySelectorAll('.rating-star').forEach(star => {
                const starRating = parseInt(star.getAttribute('data-rating'));
                star.style.color = starRating <= rating ? 'gold' : 'rgb(209 213 219)';
            });
        }

        function submitRating() {
            const reqId = parseInt(document.getElementById('current-req-id').value);
            const rating = parseInt(document.getElementById('selected-rating').value);

            if (!rating) return alert("ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุนุฏุฏ ุงููุฌูู ููุชูููู.");

            const reqIndex = db.requests.findIndex(r => r.id === reqId);
            if (reqIndex !== -1) {
                db.requests[reqIndex].rating = rating;
                saveData();
                renderPendingReviews();
                document.getElementById('rating-modal').classList.add('hidden');
                alert(`ุดูุฑุงู ูุชููููู! ุชู ุฅุฑุณุงู ${rating} ูุฌูุฉ ููููู.`);
                // ููุง ูููู ุฅุถุงูุฉ ููุทู ูุญุณุงุจ ูุชูุณุท ุชูููู ุงูููู
            }
        }


        // === 4. ูุธุงุฆู ุงูููู ===
        function updateTechWallet() {
            document.getElementById('tech-wallet').innerText = db.techWallet;
        }

        function switchTechTab(tab) {
            // ููุทู ุชุจุฏูู ุงูุชุจููุจุงุช (ููุง ูู)
            const views = { 'products': 'tech-products-view', 'requests': 'tech-requests-view' };
            const btns = { 'products': 'tab-btn-products', 'requests': 'tab-btn-requests' };
            
            for (let t in views) {
                document.getElementById(views[t]).classList.add('hidden-section');
                document.getElementById(btns[t]).classList.remove('active-tab');
                document.getElementById(btns[t]).classList.add('text-gray-500');
            }

            document.getElementById(views[tab]).classList.remove('hidden-section');
            document.getElementById(btns[tab]).classList.add('active-tab');
            document.getElementById(btns[tab]).classList.remove('text-gray-500');

            if (tab === 'requests') {
                renderRequests();
            }
        }

        function renderTechProducts() {
            const container = document.getElementById('tech-products-list');
            container.innerHTML = db.products.map(p => `
                <div class="bg-white p-4 rounded-xl shadow-sm flex gap-3">
                    <img src="${p.img}" class="w-20 h-20 object-contain bg-gray-50 rounded">
                    <div class="flex-1">
                        <h4 class="font-bold text-gray-800">${p.name}</h4>
                        <div class="flex justify-between items-center mt-2">
                            <div>
                                <span class="text-xs text-gray-400 block">ุงูุณุนุฑ ููุฒุจูู</span>
                                <span class="font-bold text-lg">${p.price} ุฏุฑูู</span>
                            </div>
                            <div class="bg-green-50 px-2 py-1 rounded text-center">
                                <span class="text-[10px] text-green-700 font-bold block">ุนูููุชู</span>
                                <span class="text-green-600 font-bold">+${p.comm}</span>
                            </div>
                        </div>
                        <button onclick="techBuy(${p.id})" class="w-full mt-2 bg-blue-900 text-white py-2 rounded font-bold text-sm">ุดุฑุงุก ููุฒุจูู</button>
                    </div>
                </div>
            `).join('');
        }

        function techBuy(id) {
            const product = db.products.find(p => p.id === id);
            if(confirm(`ุดุฑุงุก ${product.name}ุ\nุณุชุญุตู ุนูู ${product.comm} ุฏุฑูู ูู ูุญูุธุชู.`)) {
                db.techWallet += parseInt(product.comm);
                db.salesCount++;
                saveData();
                updateTechWallet();
                alert("๐ฐ ูุจุฑูู! ุชูุช ุฅุถุงูุฉ ุงูุนูููุฉ.");
            }
        }

        function renderRequests() {
            const container = document.getElementById('requests-list');
            // ูุนุฑุถ ุงูุทูุจุงุช ุงููุนููุฉ ูุงูููุจููุฉ ููุท
            const activeReqs = db.requests.filter(r => r.status === 'pending' || r.status === 'accepted');

            if(activeReqs.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-10">ูุง ุชูุฌุฏ ุทูุจุงุช ุนูู ุญุงููุงู</div>';
                return;
            }

            container.innerHTML = activeReqs.map(r => `
                <div class="bg-white border-r-4 ${r.status === 'pending' ? 'border-yellow-400' : 'border-blue-500'} p-4 rounded shadow-sm">
                    <div class="flex justify-between">
                        <h4 class="font-bold text-gray-800">${r.type}</h4>
                        <span class="text-xs ${r
