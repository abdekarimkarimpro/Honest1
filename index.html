<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="Tech Services App">Tech Services App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* ğŸ¨ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø¨Ø³Ø·Ø© ÙˆØ§Ù„Ù…Ø¹Ø¯Ù„Ø© */
        body { 
            font-family: 'Arial', sans-serif; 
            background-color: #f0f0f0; /* Ø®Ù„ÙÙŠØ© Ø£ÙØªØ­ */
            color: #333; 
            margin: 0; 
            padding: 0; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; /* ØªØºÙŠÙŠØ± Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø·ÙˆÙŠÙ„Ø© */
            min-height: 100vh;
        }
        .app-container { 
            max-width: 400px; 
            width: 95%;
            margin: 20px 0; /* Ù…Ø³Ø§ÙØ© Ø¨Ø³ÙŠØ·Ø© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙˆØ§Ù„Ø£Ø³ÙÙ„ */
            background-color: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            overflow: hidden; 
        }
        .header { 
            background-color: #3f51b5; /* Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ù‡Ø§Ø¯Ø¦ */
            color: white; 
            padding: 15px; 
            text-align: center; 
            border-radius: 8px 8px 0 0;
        }
        .title { 
            margin: 0 0 15px; 
            font-size: 1.4em; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px;
        }
        .view { 
            padding: 15px; 
            display: none; 
        }
        .active { 
            display: block; 
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙˆÙ„ */
        input[type="text"], input[type="password"], input[type="number"], textarea, select { 
            width: 100%; 
            padding: 10px; 
            margin: 8px 0; 
            border: 1px solid #ccc; 
            border-radius: 5px; 
            box-sizing: border-box; 
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn-primary, .btn-secondary, .btn-danger { 
            background-color: #007bff; 
            color: white; 
            padding: 10px 15px; 
            margin: 8px 0; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            width: 100%; 
            font-size: 1em; 
            transition: background-color 0.3s; 
        }
        .btn-secondary { 
            background-color: #6c757d; 
        }
        .btn-danger { 
            background-color: #dc3545; 
        }
        .btn-primary:hover { 
            background-color: #0056b3; 
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        .list-item { 
            background: #f9f9f9; 
            border: 1px solid #eee; 
            border-radius: 5px; 
            padding: 12px; 
            margin-bottom: 8px; 
            display: flex; 
            flex-direction: column; /* Ø¬Ø¹Ù„ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØªØªØ±Ø§ØµÙ Ø¹Ù…ÙˆØ¯ÙŠØ§Ù‹ */
            gap: 5px;
        }
        .list-item strong { 
            color: #3f51b5; 
            font-size: 1.1em;
        }
        .item-actions {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end; /* ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±/Ø§Ù„ÙŠÙ…ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ */
            gap: 8px;
        }
        .item-actions button { 
            width: auto; 
            padding: 7px 12px; 
            font-size: 0.85em;
            margin: 0;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ³Øª ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ */
        .toast { /* ... (Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙˆØ³Øª Ø§Ù„Ø³Ø§Ø¨Ù‚) */ }
        .loader { /* ... (Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚) */ }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ± */
        .role-selection { display: flex; justify-content: space-around; margin: 15px 0; }
        .role-option { text-align: center; padding: 10px; border: 2px solid #ccc; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .role-option.selected { border-color: #3f51b5; background-color: #f0f3ff; }
        .role-option input { display: none; }
        .empty-state { text-align: center; color: #6c757d; padding: 15px; border: 1px dashed #ccc; border-radius: 5px; font-size: 0.9em; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ù„Ù„Ù…Ø¯ÙŠØ± (Ù…Ø¨Ø³Ø·) */
        #pending-approvals-list .list-item {
            flex-direction: row; /* Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙÙ‚ÙŠ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø· */
            justify-content: space-between;
            align-items: center;
        }
        #pending-approvals-list .item-info {
            display: flex;
            flex-direction: column;
        }
        #pending-approvals-list .item-actions {
            margin-top: 0;
        }
        
        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„ØªÙˆØ³Øª ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ (Ù…Ø­ØªÙØ¸ Ø¨Ù‡ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„) */
        .toast { visibility: hidden; min-width: 250px; background-color: #333; color: white; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 1000; left: 50%; transform: translateX(-50%); bottom: 30px; opacity: 0; transition: opacity 0.3s; }
        .toast.show { visibility: visible; opacity: 1; }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.info { background-color: #17a2b8; }
        .loader { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); z-index: 1001; display: none; justify-content: center; align-items: center; }
        .loader.show { display: flex; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3f51b5; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1 data-translate="Tech Services Platform">Ù…Ù†ØµØ© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ©</h1>
            <div id="welcome-user"></div>
            <button id="logout-btn" class="btn-secondary" style="display:none; margin-top: 10px;" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> <span data-translate="Logout">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
            </button>
        </div>

        <div class="view" style="display: block; text-align: center; padding: 10px 15px;">
            <button onclick="setLanguage('ar')" id="lang-ar" class="btn-secondary" style="width: 45%; margin: 0; padding: 5px;">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
            <button onclick="setLanguage('en')" id="lang-en" class="btn-secondary" style="width: 45%; margin: 0; padding: 5px;">English</button>
        </div>

        <div id="login-view" class="view active">
            <h3 class="title"><i class="fas fa-sign-in-alt"></i> <span data-translate="Login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span></h3>
            <input type="number" id="login-phone" placeholder="9665xxxxxxxx" data-translate-placeholder="Phone Number">
            <input type="password" id="login-pass" placeholder="Password" data-translate-placeholder="Password">
            <button class="btn-primary" onclick="tryLogin()"><i class="fas fa-arrow-right"></i> <span data-translate="Login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span></button>
            <button class="btn-secondary" onclick="switchView('register-view')"><i class="fas fa-user-plus"></i> <span data-translate="Register">ØªØ³Ø¬ÙŠÙ„</span></button>
        </div>

        <div id="register-view" class="view">
            <h3 class="title"><i class="fas fa-user-plus"></i> <span data-translate="Register Account">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨</span></h3>
            <input type="text" id="reg-name" placeholder="Full Name" data-translate-placeholder="Full Name">
            <input type="number" id="reg-phone" placeholder="9665xxxxxxxx" data-translate-placeholder="Phone Number">
            <input type="password" id="reg-pass" placeholder="Password (Min 8 characters, Upper/Lower/Number)" data-translate-placeholder="Password (Min 8 characters, Upper/Lower/Number)">

            <label data-translate="Select Role:">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±:</label>
            <div class="role-selection" id="role-selection">
                <label for="role-client" class="role-option selected" data-role="client">
                    <input type="radio" name="role" id="role-client" value="client" checked>
                    <i class="fas fa-user"></i> <span data-translate="Client">Ø¹Ù…ÙŠÙ„</span>
                </label>
                <label for="role-tech" class="role-option" data-role="tech">
                    <input type="radio" name="role" id="role-tech" value="tech">
                    <i class="fas fa-tools"></i> <span data-translate="Technician">ÙÙ†ÙŠ</span>
                </label>
                <label for="role-admin" class="role-option" data-role="admin" style="display: none;">
                    <input type="radio" name="role" id="role-admin" value="admin">
                    <i class="fas fa-shield-alt"></i> <span data-translate="Admin">Ù…Ø¯ÙŠØ±</span>
                </label>
            </div>

            <button class="btn-primary" onclick="tryRegister()"><i class="fas fa-user-plus"></i> <span data-translate="Register">ØªØ³Ø¬ÙŠÙ„</span></button>
            <button class="btn-secondary" onclick="switchView('login-view')"><i class="fas fa-arrow-left"></i> <span data-translate="Back to Login">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span></button>
        </div>

        <div id="client-view" class="view">
            <h3 class="title"><i class="fas fa-home"></i> <span data-translate="Client Home">ØµÙØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></h3>
            <button class="btn-primary" onclick="switchViewToRequest()"><i class="fas fa-plus-circle"></i> <span data-translate="New Request">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</span></button>
            <h4><span data-translate="My Requests">Ø·Ù„Ø¨Ø§ØªÙŠ</span></h4>
            <div id="client-requests-list"></div>
        </div>
        
        <div id="tech-view" class="view">
            <h3 class="title"><i class="fas fa-wrench"></i> <span data-translate="Technician Dashboard">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ÙÙ†ÙŠ</span></h3>
            <h4><span data-translate="Wallet Balance">Ø§Ù„Ø±ØµÙŠØ¯</span>: <span id="tech-wallet">0</span> <span data-translate="SAR">Ø±.Ø³</span></h4>
            
            <h4><span data-translate="Available Requests">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</span></h4>
            <div id="available-requests-list"></div>
            
            <h4><span data-translate="My Active Requests">Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ù†Ø´Ø·Ø©</span></h4>
            <div id="tech-active-requests-list"></div>
        </div>

        <div id="admin-view" class="view">
            <h3 class="title"><i class="fas fa-chart-line"></i> <span data-translate="Admin Dashboard">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</span></h3>
            
            <h4><i class="fas fa-user-check"></i> <span data-translate="Approval Management">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª</span></h4>
            <div id="pending-approvals-list" class="list-container">
            </div>
            
            <h4 style="margin-top: 20px;"><i class="fas fa-list-alt"></i> <span data-translate="Request Oversight">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span></h4>
            <p data-translate="Manage all requests here...">Ø¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ù‡Ù†Ø§...</p>
        </div>

        <div id="request-view" class="view">
            <h3 class="title"><i class="fas fa-plus-circle"></i> <span data-translate="Submit New Request">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</span></h3>
            <select id="request-product-id"></select>
            <input type="text" id="request-details" placeholder="Detailed description of the problem..." data-translate-placeholder="Detailed description of the problem...">
            <input type="number" id="request-price" placeholder="Proposed Price (SAR)" data-translate-placeholder="Proposed Price (SAR)">
            <button class="btn-primary" onclick="submitRequest()"><i class="fas fa-paper-plane"></i> <span data-translate="Submit Request">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</span></button>
            <button class="btn-secondary" onclick="loadApp()"><i class="fas fa-arrow-left"></i> <span data-translate="Back">Ø±Ø¬ÙˆØ¹</span></button>
        </div>

    </div>

    <div id="toast" class="toast"></div>
    <div id="loader" class="loader"><div class="spinner"></div></div>

<script>
    // =================================================================
    // =========== 1. ØªÙ‡ÙŠØ¦Ø© Firebase ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© =================
    // =================================================================

    // **!!! ØªØ°ÙƒÙŠØ±: ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ !!!**
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.appspot.com",
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID"
    };

    // ØªÙ‡ÙŠØ¦Ø© Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db_cloud = firebase.firestore();

    // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Cache) - Ø³Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© ÙÙ‚Ø· Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† localStorage
    let db = {
        current: null, // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        users: [], // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù„ØºØ±Ø¶ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø§Ù„Ù…Ø¤Ù‚Øª)
        products: [ // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            { id: 1, name: 'Laptop Repair', name_ar: 'Ø¥ØµÙ„Ø§Ø­ Ø­Ø§Ø³ÙˆØ¨ Ù…Ø­Ù…ÙˆÙ„' },
            { id: 2, name: 'Phone Screen Replacement', name_ar: 'ØªØºÙŠÙŠØ± Ø´Ø§Ø´Ø© Ù‡Ø§ØªÙ' },
            { id: 3, name: 'Software Installation', name_ar: 'ØªÙ†ØµÙŠØ¨ Ø¨Ø±Ù…Ø¬ÙŠØ§Øª' },
            { id: 4, name: 'Network Setup', name_ar: 'Ø¥Ø¹Ø¯Ø§Ø¯ Ø´Ø¨ÙƒØ§Øª' }
        ],
        requests: [], // Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        techLogs: [], // Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙÙ†ÙŠÙŠÙ†
        withdrawals: [], // Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨ Ø§Ù„Ø±ØµÙŠØ¯
        lang: 'ar'
    };
    
    // Ù„ØºØ© Ø§Ù„ØªØ±Ø¬Ù…Ø©
    const translations = {
        'en': {
            "Tech Services App": "Tech Services App",
            "Tech Services Platform": "Tech Services Platform",
            "Login": "Login",
            "Phone Number": "Phone Number",
            "Password": "Password",
            "Register": "Register",
            "Back to Login": "Back to Login",
            "Register Account": "Register Account",
            "Full Name": "Full Name",
            "Select Role:": "Select Role:",
            "Client": "Client",
            "Technician": "Technician",
            "Admin": "Admin",
            "Client Home": "Client Home",
            "New Request": "New Request",
            "My Requests": "My Requests",
            "Technician Dashboard": "Technician Dashboard",
            "Available Requests": "Available Requests",
            "My Active Requests": "My Active Requests",
            "Wallet Balance": "Wallet Balance",
            "SAR": "SAR",
            "Admin Dashboard": "Admin Dashboard",
            "Pending Techs": "Pending Techs",
            "Total Clients": "Total Clients",
            "Total Requests": "Total Requests",
            "Approval Management": "Approval Management",
            "Request Oversight": "Request Oversight",
            "Manage all requests here...": "Manage all requests here...",
            "Submit New Request": "Submit New Request",
            "Detailed description of the problem...": "Detailed description of the problem...",
            "Proposed Price (SAR)": "Proposed Price (SAR)",
            "Submit Request": "Submit Request",
            "Back": "Back",
            "Logout": "Logout",
            "Please fill in all details.": "Please fill in all details.",
            "Phone number must be exactly 10 digits.": "Phone number must be exactly 10 digits.",
            "Password must be at least 8 characters, including uppercase, lowercase, and a number.": "Password must be at least 8 characters, including uppercase, lowercase, and a number.",
            "User with this phone number already exists.": "User with this phone number already exists.",
            "Account created. It must be approved by an administrator before login.": "Account created. It must be approved by an administrator before login.",
            "Account created. Please log in.": "Account created. Please log in.",
            "Please fill in all fields.": "Please fill in all fields.",
            "Incorrect Phone or Password.": "Incorrect Phone or Password.",
            "Your technician account is pending admin approval.": "Your technician account is pending admin approval.",
            "Welcome back,": "Welcome back,",
            "No technicians pending approval.": "No technicians pending approval.",
            "Approve": "Approve",
            "Reject": "Reject",
            "Reg:": "Reg:",
            "Welcome": "Welcome",
            "Select a Service": "Select a Service",
            "Logout successful!": "Logout successful!",
            "Please fill in all request details correctly.": "Please fill in all request details correctly.",
            "Request submitted successfully!": "Request submitted successfully!",
            "A new request has been submitted and is awaiting a technician.": "A new request has been submitted and is awaiting a technician.",
            "Technician approved!": "Technician approved!",
            "User rejected and removed.": "User rejected and removed.",
            "No requests found.": "No requests found.",
            "Status": "Status",
            "Price": "Price",
            "No available requests.": "No available requests.",
            "Accept": "Accept",
            "No active requests.": "No active requests.",
            "Finish": "Finish"
        },
        'ar': {
            "Tech Services App": "ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ©",
            "Tech Services Platform": "Ù…Ù†ØµØ© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ©",
            "Login": "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
            "Phone Number": "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ",
            "Password": "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
            "Register": "ØªØ³Ø¬ÙŠÙ„",
            "Back to Login": "Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
            "Register Account": "ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨",
            "Full Name": "Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„",
            "Select Role:": "Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±:",
            "Client": "Ø¹Ù…ÙŠÙ„",
            "Technician": "ÙÙ†ÙŠ",
            "Admin": "Ù…Ø¯ÙŠØ±",
            "Client Home": "ØµÙØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
            "New Request": "Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯",
            "My Requests": "Ø·Ù„Ø¨Ø§ØªÙŠ",
            "Technician Dashboard": "Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ÙÙ†ÙŠ",
            "Available Requests": "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©",
            "My Active Requests": "Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ù†Ø´Ø·Ø©",
            "Wallet Balance": "Ø§Ù„Ø±ØµÙŠØ¯",
            "SAR": "Ø±.Ø³",
            "Admin Dashboard": "Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±",
            "Pending Techs": "Ø§Ù„ÙÙ†ÙŠÙˆÙ† Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©",
            "Total Clients": "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡",
            "Total Requests": "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª",
            "Approval Management": "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª",
            "Request Oversight": "Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª",
            "Manage all requests here...": "Ø¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ù‡Ù†Ø§...",
            "Submit New Request": "Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯",
            "Detailed description of the problem...": "ÙˆØµÙ Ù…ÙØµÙ„ Ù„Ù„Ù…Ø´ÙƒÙ„Ø©...",
            "Proposed Price (SAR)": "Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­ (Ø±.Ø³)",
            "Submit Request": "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨",
            "Back": "Ø±Ø¬ÙˆØ¹",
            "Logout": "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",
            "Please fill in all details.": "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙØ§ØµÙŠÙ„.",
            "Phone number must be exactly 10 digits.": "ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙƒÙˆÙ† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù… Ø¨Ø§Ù„Ø¶Ø¨Ø·.",
            "Password must be at least 8 characters, including uppercase, lowercase, and a number.": "ÙŠØ¬Ø¨ Ø£Ù† ØªØªÙƒÙˆÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ù† 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ØŒ Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø­Ø±Ù ÙƒØ¨ÙŠØ± ÙˆØµØºÙŠØ± ÙˆØ±Ù‚Ù….",
            "User with this phone number already exists.": "ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù‡Ø°Ø§ Ù…Ø³Ø¨Ù‚Ø§Ù‹.",
            "Account created. It must be approved by an administrator before login.": "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ù…Ø¯ÙŠØ± Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.",
            "Account created. Please log in.": "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.",
            "Please fill in all fields.": "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.",
            "Incorrect Phone or Password.": "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.",
            "Your technician account is pending admin approval.": "Ø­Ø³Ø§Ø¨ Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø¯ÙŠØ±.",
            "Welcome back,": "Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ØŒ",
            "No technicians pending approval.": "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙ†ÙŠÙˆÙ† Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©.",
            "Approve": "Ù…ÙˆØ§ÙÙ‚Ø©",
            "Reject": "Ø±ÙØ¶",
            "Reg:": "ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„:",
            "Welcome": "Ø£Ù‡Ù„Ø§Ù‹",
            "Select a Service": "Ø§Ø®ØªØ± Ø®Ø¯Ù…Ø©",
            "Logout successful!": "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­!",
            "Please fill in all request details correctly.": "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.",
            "Request submitted successfully!": "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!",
            "A new request has been submitted and is awaiting a technician.": "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙˆÙ‡Ùˆ Ø¨Ø§Ù†ØªØ¸Ø§Ø± ÙÙ†ÙŠ.",
            "Technician approved!": "ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙÙ†ÙŠ!",
            "User rejected and removed.": "ØªÙ… Ø±ÙØ¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ¥Ø²Ø§Ù„ØªÙ‡.",
            "No requests found.": "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ø§Øª.",
            "Status": "Ø§Ù„Ø­Ø§Ù„Ø©",
            "Price": "Ø§Ù„Ø³Ø¹Ø±",
            "No available requests.": "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ØªØ§Ø­Ø©.",
            "Accept": "Ù‚Ø¨ÙˆÙ„",
            "No active requests.": "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù†Ø´Ø·Ø©.",
            "Finish": "Ø¥Ù†Ù‡Ø§Ø¡"
        }
    };
    
    function t(key) {
        return translations[db.lang][key] || key;
    }
    
    // =================================================================
    // =========== 2. Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø§Ù…Ø© (UI/Utils) ======================
    // =================================================================

    function switchView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        if (viewId !== 'login-view' && viewId !== 'register-view') {
            document.getElementById('logout-btn').style.display = 'block';
        } else {
            document.getElementById('logout-btn').style.display = 'none';
        }
    }

    function showToast(message, type = 'info') {
        const toastElm = document.getElementById('toast');
        toastElm.innerText = message;
        toastElm.className = 'toast show ' + type;
        setTimeout(() => {
            toastElm.className = toastElm.className.replace("show", "");
        }, 3000);
    }

    function showLoader() {
        document.getElementById('loader').classList.add('show');
    }

    function hideLoader() {
        document.getElementById('loader').classList.remove('show');
    }

    // ğŸ”” Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
    function notifyUser(message, type = 'info') {
        showToast(message, type);
    }
    
    function setLanguage(lang) {
        db.lang = lang;
        document.querySelectorAll('.lang-select button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`lang-${lang}`).classList.add('active');
        document.body.dir = (lang === 'ar') ? 'rtl' : 'ltr';
        applyTranslations();
        if (db.current) {
            loadApp();
        }
    }
    
    function applyTranslations() {
        document.querySelectorAll('[data-translate]').forEach(el => {
            const key = el.getAttribute('data-translate');
            el.innerText = t(key);
        });
        document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
            const key = el.getAttribute('data-translate-placeholder');
            el.placeholder = t(key);
        });
        if (db.current) updateProductOptions();
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function getSafeData() {
        const data = localStorage.getItem('tech_services_db');
        if (data) {
            db = JSON.parse(data);
        }
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ§Ø´ (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„Ù„ØºØ©)
        const cache = localStorage.getItem('tech_services_cache');
        if (cache) {
            const cacheData = JSON.parse(cache);
            db.current = cacheData.current;
            db.lang = cacheData.lang;
        }
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø­ÙØ¸
    function save() {
        // Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„Ù„ØºØ© ÙÙŠ Ø§Ù„ÙƒØ§Ø´
        const currentData = {
            current: db.current,
            lang: db.lang
        };
        localStorage.setItem('tech_services_cache', JSON.stringify(currentData));
        // Ù„Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù„Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·):
        localStorage.setItem('tech_services_db', JSON.stringify(db));
    }

    // =================================================================
    // =========== 3. Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Authentication) ===================
    // =================================================================

    function tryRegister() {
        const name = document.getElementById('reg-name').value.trim();
        const phone = document.getElementById('reg-phone').value.trim();
        const pass = document.getElementById('reg-pass').value.trim();
        const role = document.querySelector('input[name="role"]:checked').value;

        // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
        if (!name || !phone || !pass) {
            return showToast(t("Please fill in all details."), 'error');
        }

        // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙ†Ø³ÙŠÙ‚ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (10 Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·)
        const phoneRegex = /^\d{10}$/;
        if (!phoneRegex.test(phone)) {
            return showToast(t("Phone number must be exactly 10 digits."), 'error');
        }

        // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ØŒ ØªØ´Ù…Ù„ ÙƒØ¨ÙŠØ±Ø§Ù‹ ÙˆØµØºÙŠØ±Ø§Ù‹ ÙˆØ±Ù‚Ù…)
        const passwordRegex = /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}$/;
        if (!passwordRegex.test(pass)) {
            return showToast(t("Password must be at least 8 characters, including uppercase, lowercase, and a number."), 'error');
        }

        // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ù„ÙŠØ§Ù‹ (Ù„Ù„ØªØ¬Ø±Ø¨Ø©)
        const existing = db.users.find(u => u.phone === phone);
        if (existing) {
            return showToast(t("User with this phone number already exists."), 'error');
        }

        const newUser = {
            id: Date.now(),
            name,
            phone,
            pass, 
            role,
            wallet: 0,
            isApproved: (role === 'admin' || role === 'client'),
            regDate: new Date().toLocaleDateString(db.lang === 'ar' ? 'ar-SA' : 'en-US')
        };

        db.users.push(newUser);
        save(); 

        switchView('login-view');
        const msg = (role === 'tech') 
            ? t("Account created. It must be approved by an administrator before login.") 
            : t("Account created. Please log in.");
        showToast(msg, 'success');
    }

    function tryLogin() {
        const phone = document.getElementById('login-phone').value.trim();
        const pass = document.getElementById('login-pass').value.trim();

        if (!phone || !pass) {
            return showToast(t("Please fill in all fields."), 'error');
        }

        // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø­Ù„ÙŠØ§Ù‹ (Ù„Ù„ØªØ¬Ø±Ø¨Ø©)
        const user = db.users.find(u => u.phone === phone && u.pass === pass);

        if (user) {
            if (!user.isApproved && user.role === 'tech') {
                return showToast(t("Your technician account is pending admin approval."), 'error');
            }

            db.current = user;
            save(); // Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„ÙƒØ§Ø´
            loadApp();
            notifyUser(t("Welcome back,") + ' ' + user.name + '!', 'info');

        } else {
            showToast(t("Incorrect Phone or Password."), 'error');
        }
    }

    function logout() {
        db.current = null;
        save();
        switchView('login-view');
        showToast(t("Logout successful!"), 'info');
    }

    // =================================================================
    // =========== 4. Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Data/UI Loading) =============
    // =================================================================

    function loadApp() {
        if (!db.current) {
            return switchView('login-view');
        }

        document.getElementById('welcome-user').innerText = t("Welcome") + ' ' + db.current.name;

        switch (db.current.role) {
            case 'client':
                loadClient();
                break;
            case 'tech':
                loadTech();
                break;
            case 'admin':
                loadAdmin();
                break;
            default:
                logout();
        }
    }
    
    // ğŸ’¡ Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (Client)
    function loadClient() {
        switchView('client-view');
        const clientRequests = db.requests.filter(req => req.clientId === db.current.id);
        const listElm = document.getElementById('client-requests-list');
        listElm.innerHTML = clientRequests.length === 0 
            ? `<p class="empty-state">${t("No requests found.")}</p>`
            : clientRequests.map(req => `
                <div class="list-item">
                    <div><strong>${req.productName}</strong></div>
                    <small>${t("Status")}: ${t(req.status)} | ${t("Price")}: ${req.price} SAR</small>
                    <small>${req.details}</small>
                </div>
            `).join('');
    }

    // ğŸ’¡ Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø´Ø§Ø´Ø© Ø§Ù„ÙÙ†ÙŠ (Technician)
    function loadTech() {
        switchView('tech-view');
        document.getElementById('tech-wallet').innerText = db.current.wallet;
        
        const availableRequests = db.requests.filter(req => req.status === 'Pending');
        const activeRequests = db.requests.filter(req => req.techId === db.current.id && (req.status === 'Accepted' || req.status === 'InProgress'));

        document.getElementById('available-requests-list').innerHTML = availableRequests.length === 0 
            ? `<p class="empty-state">${t("No available requests.")}</p>`
            : availableRequests.map(req => `
                <div class="list-item">
                    <div><strong>${req.productName}</strong> - ${req.details}</div>
                    <div class="item-actions">
                        <button class="btn-primary" onclick="acceptRequest(${req.id})">${t("Accept")}</button>
                    </div>
                </div>
            `).join('');
            
        document.getElementById('tech-active-requests-list').innerHTML = activeRequests.length === 0
            ? `<p class="empty-state">${t("No active requests.")}</p>`
            : activeRequests.map(req => `
                <div class="list-item">
                    <div><strong>${req.productName}</strong> - ${req.details}</div>
                    <div class="item-actions">
                        <button class="btn-secondary" onclick="finishRequest(${req.id})">${t("Finish")}</button>
                    </div>
                </div>
            `).join('');
    }

    // ğŸ’¡ Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø¯ÙŠØ± (Admin)
    function loadAdmin() {
        switchView('admin-view');
        
        const pendingTechs = db.users.filter(u => u.role === 'tech' && !u.isApproved);
        
        const listElement = document.getElementById('pending-approvals-list');
        listElement.innerHTML = ''; 

        if (pendingTechs.length === 0) {
            listElement.innerHTML = `<p class="empty-state">${t("No technicians pending approval.")}</p>`;
        } else {
            pendingTechs.forEach(user => {
                const userItem = `
                    <div class="list-item user-item" data-id="${user.id}">
                        <div class="item-info">
                            <strong>${user.name}</strong> 
                            <small>${user.phone} (${t("Reg:")} ${user.regDate})</small>
                        </div>
                        <div class="item-actions">
                            <button class="btn-primary" onclick="approveUser(${user.id})">
                                <i class="fas fa-check"></i> ${t("Approve")}
                            </button>
                            <button class="btn-danger" onclick="deleteUser(${user.id})">
                                <i class="fas fa-times"></i> ${t("Reject")}
                            </button>
                        </div>
                    </div>
                `;
                listElement.innerHTML += userItem;
            });
        }
    }
    
    // ğŸ’¡ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø´Ø§Ø´Ø© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
    function updateProductOptions() {
        const select = document.getElementById('request-product-id');
        select.innerHTML = `<option value="">-- ${t("Select a Service")} --</option>`;
        db.products.forEach(p => {
            const name = db.lang === 'ar' ? p.name_ar : p.name;
            select.innerHTML += `<option value="${p.id}">${name}</option>`;
        });
    }

    function switchViewToRequest() {
        updateProductOptions();
        switchView('request-view');
    }

    // =================================================================
    // =========== 5. Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (CRUD - Ù…Ø­Ø§ÙƒØ§Ø©) =====================
    // =================================================================

    function submitRequest() {
        const productId = document.getElementById('request-product-id').value;
        const details = document.getElementById('request-details').value.trim();
        const price = parseFloat(document.getElementById('request-price').value.trim());

        if (!productId || !details || isNaN(price) || price <= 0) {
            return showToast(t("Please fill in all request details correctly."), 'error');
        }

        const product = db.products.find(p => p.id == productId);
        
        const newRequest = {
            id: Date.now(),
            clientId: db.current.id,
            productName: db.lang === 'ar' ? product.name_ar : product.name,
            details,
            price,
            status: 'Pending',
            techId: null,
            date: new Date().toLocaleDateString(db.lang === 'ar' ? 'ar-SA' : 'en-US')
        };

        db.requests.push(newRequest);
        save();
        
        showToast(t("Request submitted successfully!"), 'success');
        notifyUser(t("A new request has been submitted and is awaiting a technician."), 'info');
        loadClient();
    }

    function approveUser(userId) {
        const user = db.users.find(u => u.id === userId);
        if (user) {
            user.isApproved = true;
            save(); 
            showToast(t("Technician approved!"), 'success');
            loadAdmin();
        }
    }

    function deleteUser(userId) {
        db.users = db.users.filter(u => u.id !== userId);
        save(); 
        showToast(t("User rejected and removed."), 'warning');
        loadAdmin();
    }
    
    function acceptRequest(requestId) {
        const request = db.requests.find(r => r.id === requestId);
        if (request) {
            request.status = 'Accepted';
            request.techId = db.current.id;
            save();
            showToast("Request accepted. Start working!", 'success');
            loadTech();
            // Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„
            // notifyUser("Your request has been accepted by a technician!", 'info');
        }
    }

    function finishRequest(requestId) {
        const request = db.requests.find(r => r.id === requestId);
        if (request && request.techId === db.current.id) {
            request.status = 'Completed';
            db.current.wallet += request.price; // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯
            save();
            showToast("Request completed successfully! Wallet updated.", 'success');
            loadTech();
            // Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„
            // notifyUser("Your service request has been completed!", 'success');
        }
    }

    // =================================================================
    // =========== 6. Ø§Ù„ØªÙ‡ÙŠØ¦ Ø§Ù„Ø£ÙˆÙ„ÙŠ (Initial Setup) ===================
    // =================================================================

    // Ø±Ø¨Ø· Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ± ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    document.getElementById('role-selection').addEventListener('click', (e) => {
        const label = e.target.closest('.role-option');
        if (label) {
            document.querySelectorAll('.role-option').forEach(l => l.classList.remove('selected'));
            label.classList.add('selected');
            label.querySelector('input').checked = true;
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        getSafeData();
        setLanguage(db.lang);
        loadApp();
    });
</script>

</body>
</html>
