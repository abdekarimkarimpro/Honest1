<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Models\PurchaseOrder; // ØªØ£ÙƒØ¯ Ø£Ù† Ù„Ø¯ÙŠÙƒ Ù†Ù…ÙˆØ°Ø¬ (Model) Ø¨Ø§Ø³Ù… PurchaseOrder
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;

class PurchaseWorkflowController extends Controller
{
    // --- 1. ÙˆØ¸ÙŠÙØ© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (ÙŠÙ†ÙØ°Ù‡Ø§ Ø§Ù„ÙÙ†ÙŠ) ---

    public function submitPurchaseOrder(Request $request)
    {
        // ØªØ­Ù‚Ù‚ Ù…Ø¨Ø¯Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
        if (!Auth::check()) {
            return response()->json(['error' => 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.'], 401);
        }

        // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© (ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù€ $request Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©)
        $description = $request->input('description', 'Ø´Ø±Ø§Ø¡ Ù…Ø¹Ø¯Ø§Øª ØµÙŠØ§Ù†Ø©.');
        $totalAmount = $request->input('total_amount', 1500.00);

        // **Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ:** ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¯ÙŠØ± (Approver) ÙˆØ§Ù„Ø­Ø§Ù„Ø© (Status)
        $managerId = 5; // ðŸ‘ˆ Ù‚Ù… Ø¨ØªØºÙŠÙŠØ± Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ù€ ID Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
        $submitterId = Auth::id();

        try {
            $order = PurchaseOrder::create([
                'submitter_id' => $submitterId,
                'approver_id' => $managerId,
                'status' => 'pending_manager_approval', // ðŸ‘ˆ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙˆØ§Ù„Ù…ÙˆØ­Ø¯Ø©
                'description' => $description,
                'total_amount' => $totalAmount,
            ]);

            return response()->json([
                'message' => 'âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­. Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø¯ÙŠØ±.',
                'order_id' => $order->id
            ]);

        } catch (\Exception $e) {
            return response()->json(['error' => 'âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨: ' . $e->getMessage()], 500);
        }
    }


    // --- 2. ÙˆØ¸ÙŠÙØ© Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© (ÙŠÙ†ÙØ°Ù‡Ø§ Ø§Ù„Ù…Ø¯ÙŠØ±) ---

    public function approvalDashboard()
    {
        // ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ±
        if (!Auth::check()) {
            return redirect('/login');
        }

        $currentManagerId = Auth::id();

        // **Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ù‡Ù…:** Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Query) Ø§Ù„Ø°ÙŠ ÙŠØ¸Ù‡Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
        $pendingOrders = PurchaseOrder::where('status', 'pending_manager_approval') // ÙŠØ¬Ø¨ Ø£Ù† ØªØ·Ø§Ø¨Ù‚ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                                      ->where('approver_id', $currentManagerId)    // ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ·Ø§Ø¨Ù‚ ID Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡
                                      ->orderBy('id', 'desc')
                                      ->get();

        // ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© (Ø§Ù„Ù€ HTML Ø£Ø¯Ù†Ø§Ù‡)
        return view('manager.approvals_view', [
            'pendingOrders' => $pendingOrders,
            'managerName' => Auth::user()->name ?? 'Ø§Ù„Ù…Ø¯ÙŠØ±'
        ]);
    }


    // --- 3. ÙˆØ¸ÙŠÙØ© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ (ÙŠÙ†ÙØ°Ù‡Ø§ Ø§Ù„Ù…Ø¯ÙŠØ±) ---

    public function approveOrder(Request $request, PurchaseOrder $order)
    {
        // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        if ($order->approver_id !== Auth::id() || $order->status !== 'pending_manager_approval') {
            return back()->with('error', 'ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨ØªØ£ÙƒÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¤ÙƒØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹.');
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
        $order->status = 'approved';
        $order->save();

        return back()->with('success', 'âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­.');
    }
}
