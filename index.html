<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Models\PurchaseOrder; // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†Ù…ÙˆØ°Ø¬ PurchaseOrder
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;

class PurchaseWorkflowController extends Controller
{
    /**
     * [1] ÙˆØ¸ÙŠÙØ© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (Submit): ÙŠÙ†ÙØ°Ù‡Ø§ Ø§Ù„ÙÙ†ÙŠ.
     * ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ÙØ±Ø§Ø¬Ø¹.
     */
    public function submitPurchaseOrder(Request $request)
    {
        // ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙŠØ¬Ø¨ ØªÙƒÙŠÙŠÙÙ‡Ø§ Ø­Ø³Ø¨ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ)
        $request->validate([
            'description' => 'required|string',
            'total_amount' => 'required|numeric|min:1',
        ]);
        
        // **Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ø³Ù… 1: ØªØ­Ø¯ÙŠØ¯ Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø¯ÙŠØ±**
        // ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ù€ ID Ø§Ù„Ø®Ø§Øµ Ø¨Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø£Ùˆ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        $managerId = 5; // ðŸ‘ˆ Ù…Ø«Ø§Ù„: ID Ø§Ù„Ù…Ø¯ÙŠØ±. ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø¯Ø§Ù„Ø© ØªØ¬Ù„Ø¨ ID Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ¹Ù„ÙŠ.

        try {
            $order = PurchaseOrder::create([
                'submitter_id' => Auth::id(),
                'approver_id' => $managerId,
                'status' => 'pending_manager_approval', // ðŸ‘ˆ ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¯Ù‚Ø©
                'description' => $request->input('description'),
                'total_amount' => $request->input('total_amount'),
            ]);

            return redirect()->back()->with('success', 'âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡. Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø¯ÙŠØ±.');

        } catch (\Exception $e) {
            return redirect()->back()->with('error', 'âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.');
        }
    }


    /**
     * [2] ÙˆØ¸ÙŠÙØ© Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± (Dashboard): ÙŠÙ†ÙØ°Ù‡Ø§ Ø§Ù„Ù…Ø¯ÙŠØ±.
     * Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ ÙŠØµÙ„Ø­ Ù…Ø´ÙƒÙ„Ø© "Ø¹Ø¯Ù… Ø¸Ù‡ÙˆØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª".
     */
    public function approvalDashboard()
    {
        if (!Auth::check()) {
            return redirect('/login');
        }

        $currentManagerId = Auth::id();

        // **Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ø³Ù… 2: Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„ØµØ­ÙŠØ­ (Query)**
        $pendingOrders = PurchaseOrder::where('status', 'pending_manager_approval') 
                                      ->where('approver_id', $currentManagerId)    
                                      ->with('submitter') // Ù„Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ
                                      ->orderBy('id', 'desc')
                                      ->get();

        return view('manager.approvals_view', [
            'pendingOrders' => $pendingOrders,
            'managerName' => Auth::user()->name ?? 'Ø§Ù„Ù…Ø¯ÙŠØ±'
        ]);
    }


    /**
     * [3] ÙˆØ¸ÙŠÙØ© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ (Approve): ÙŠÙ†ÙØ°Ù‡Ø§ Ø§Ù„Ù…Ø¯ÙŠØ±.
     */
    public function approveOrder(Request $request, PurchaseOrder $order)
    {
        // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ§Ù„Ø­Ø§Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯
        if ($order->approver_id !== Auth::id() || $order->status !== 'pending_manager_approval') {
            return back()->with('error', 'ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨ØªØ£ÙƒÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¤ÙƒØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹.');
        }

        $order->status = 'approved';
        $order->save();

        // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„ÙÙ†ÙŠ Ø¨Ø£Ù† Ø·Ù„Ø¨Ù‡ ØªÙ… ØªØ£ÙƒÙŠØ¯Ù‡
        
        return back()->with('success', 'âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­.');
    }
}
